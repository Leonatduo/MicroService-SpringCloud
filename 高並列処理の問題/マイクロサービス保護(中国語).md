# 微服务保护（マイクロサービス保護）

## 1. 微服务远程调用中的问题

在微服务远程调用的过程中，还存在几个问题需要解决。。

### 1.1 业务健壮性问题

例如在查询购物车列表业务中：
- 购物车服务需要查询最新的商品信息，与购物车数据做对比，提醒用户
- 如果商品服务查询时发生故障，查询购物车列表在调用商品服务时也会异常，从而导致购物车查询失败
- 但从业务角度来说，为了提升用户体验，即便是商品查询失败，购物车列表也应该正确展示出来（哪怕不包含最新的商品信息）

### 1.2 级联失败（雪崩）问题

以查询购物车业务为例：
1. 如果商品服务并发较高，占用过多 Tomcat 连接，可能导致：
   - 商品服务的所有接口响应时间增加、延迟变高，甚至长时间阻塞直至查询失败
2. 查询购物车业务需要等待商品查询结果，因此：
   - 购物车列表的响应时间也变长，甚至阻塞直至无法访问
3. 如果查询购物车的请求较多：
   - 购物车服务的 Tomcat 连接占用较多，所有接口响应时间增加，整个服务性能下降甚至不可用
4. 最终影响：
   - 与购物车服务、商品服务有调用关系的其他微服务都可能出现问题，导致整个集群不可用

这就是**级联失败问题**（或**雪崩问题**）。

---

## 2. 微服务保护（サービス保護）

**目标**：保证服务运行的健壮性，避免级联失败导致的雪崩问题。

### 2.1 服务保护方案

常见的微服务保护方案（服务降级策略）：
- **请求限流（リクエストレート制限）**
- **线程隔离（スレッド隔離）**
- **服务熔断（サーキットブレーカー）**

这些方案会略微降低服务体验，但能提升健壮性：
- 请求限流 → 降低并发上限  
- 线程隔离 → 减少可用资源数量  
- 服务熔断 → 部分服务变为不可用/弱可用  

---

### 2.1.1 请求限流（レート制限）

**核心思想**：  
服务故障的主要原因之一是并发过高。通过限制接口的并发流量，避免因突发流量激增导致故障。

**类比**：  
类似水电站大坝，通过限流器（ダム）将起伏的请求流量调整为平稳的输出。

---

### 2.1.2 线程隔离（スレッド隔離）

**问题场景**：  
高并发 + 响应时间长的接口可能耗尽服务器线程资源，影响其他接口。

**解决方案**：  
通过线程隔离限制故障影响范围，避免拖垮整个服务。

---

### 2.1.3 服务熔断（サーキットブレーカー）

**线程隔离的不足**：  
- 故障服务（如商品服务）仍会拖慢调用方（如购物车服务）的响应速度。  
- 商品查询失败可能导致购物车功能完全不可用。  

**解决方案**：  
1. **服务降级逻辑**：  
   - 调用失败后的处理逻辑（如返回默认数据、友好提示或抛出异常）。  
2. **异常统计与熔断**：  
   - 统计服务提供方的异常比例，超过阈值时直接触发降级逻辑，拒绝调用故障接口。  
