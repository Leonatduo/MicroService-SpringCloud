# 微服务保护

## 1. 微服务远程调用中的问题

### 1.1 业务健壮性问题
**场景示例**：购物车查询业务  
- 购物车服务需查询商品信息进行数据对比  
- 商品服务故障会导致购物车查询异常  
- **业务需求**：即使商品查询失败，也应正常展示购物车列表（可降级显示旧数据）

### 1.2 级联失败（雪崩问题）
**发生过程**：  
1. 商品服务高并发 → 占用过多Tomcat连接 → 接口响应变慢/阻塞  
2. 购物车服务等待商品查询 → 响应时间变长 → 逐渐阻塞  
3. 购物车请求积压 → 占用更多连接 → 服务性能下降  
4. 连锁反应 → 关联微服务相继故障 → 集群不可用  

---

## 2. 微服务保护方案

### 2.1 核心保护策略
| 方案         | 作用原理                          | 效果                          | 代价                  |
|--------------|-----------------------------------|-----------------------------|-----------------------|
| 请求限流     | 限制接口并发流量                  | 平滑突发流量                | 降低峰值处理能力      |
| 线程隔离     | 划分独立线程池资源                | 故障服务隔离                | 减少可用资源总量      |
| 服务熔断     | 异常统计+自动降级                 | 快速失败保护系统            | 部分服务弱可用        |

### 2.1.1 请求限流
**实现类比**：  
> 类似水电站大坝，通过限流器将波动请求流量转换为平稳输出

**关键点**：
- 设置QPS阈值
- 超额请求直接拒绝/排队

### 2.1.2 线程隔离
**典型场景**：  
- 高并发+长响应接口 → 耗尽线程资源  
- 影响其他正常接口  

**解决方案**：  
- 为不同服务分配独立线程池
- 故障服务不会占用全部资源

### 2.1.3 服务熔断
**线程隔离的局限**：  
- 故障服务仍会拖慢调用方响应  
- 可能导致核心功能不可用  

**熔断机制**：  
1. **降级逻辑**（Fallback）：  
   - 默认返回值  
   - 友好提示  
   - 异常抛出  
2. **熔断触发**：  
   - 统计异常比例（如50%）  
   - 超阈值时自动触发降级  
   - 熔断后快速失败  

**熔断状态机**：  
- 关闭 → 异常超阈值 → 打开 → 冷却期 → 半开 → 成功恢复/继续熔断
