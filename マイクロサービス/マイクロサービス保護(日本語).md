# マイクロサービス保護

サービスが堅牢に動作することを保証し、連鎖的な失敗による雪崩（アバランシェ）問題を回避することを「マイクロサービス保護」と呼びます。この章では、マイクロサービス保護の一般的なソリューションと対応する技術を学びます。

## 1.1. サービス保護ソリューション

マイクロサービス保護にはさまざまなソリューションがあります。例えば：

- **リクエストレート制限（スロットリング）**
- **スレッド分離（スレッドアイソレーション）**
- **サーキットブレーカー（サービス遮断）**

これらのソリューションは、多少なりともサービスのユーザーエクスペリエンスを低下させる可能性があります。例えば：
- リクエストレート制限は、同時実行数の上限を下げます。
- スレッド分離は、利用可能なリソース量を減少させます。
- サーキットブレーカーは、サービスの完全性を低下させ、一部のサービスを利用不能または部分利用可能にします。

しかし、これらのソリューションにより、サービスの堅牢性は向上します。次に、これらのソリューションの原理を詳しく見ていきましょう。

### 1.1.1. リクエストレート制限

サービスの障害の最も重要な原因は、**過剰な同時リクエスト**です。この問題を解決すれば、ほとんどの障害を回避できます。ただし、インターフェースの同時リクエスト数は常に高いわけではなく、突発的に増加することがあります。したがって、リクエストレート制限は、インターフェースへのアクセス同時リクエスト数を制限または制御し、トラフィックの急増によるサービス障害を防ぎます。

リクエストレート制限には通常、「**レートリミッター**」が使用されます。変動の激しい同時リクエスト曲線は、レートリミッターを通過すると非常に平滑化されます。これは、水力発電所のダムのようなもので、水の流出量を制御し、下流の水流を一定に保つ役割を果たします。

### 1.1.2. スレッド分離（スレッドアイソレーション）

あるビジネスインターフェースの応答時間が長く、同時リクエスト数が多い場合、サーバーのスレッドリソースが枯渇し、サービス内の他のインターフェースに影響を与える可能性があります。この影響を軽減するため、**スレッド分離**が効果的な解決策です。

スレッド分離の考え方は、船舶の「**バルクヘッド（隔壁）パターン**」に由来します：
船舶の船体は隔壁でN個の密閉区画に分割されています。もし船が座礁して浸水しても、損傷した区画のみが浸水し、他の区画は隔離されているため浸水しません。これにより、浸水が船体の一部に限定され、船全体が沈没するのを防ぎます。

同様に、あるインターフェースの障害や過負荷がサービス全体に影響を与えないように、各インターフェースが使用できるリソース範囲を制限し、「分離」します。

例えば、ショッピングカートのクエリ業務に使用可能なスレッド数の上限を20に設定します。これにより、商品サービスに問題が発生しても、サーバーのスレッドリソースが枯渇せ

